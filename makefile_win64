CC = g++ -m64 -std=c++20

BIN_DIR = .
SRC_DIR = src

OCL_INC = -IKhronos
OCL_LIB = C:/Windows/System32/OpenCL.dll

CFLAGS = -Wall -Wextra -Wsign-conversion -ffinite-math-only
FLAGS_CPU = -O3
FLAGS_GPU = -O2 -DGPU

OBJS_CPU = marinc.o cpu.o
OBJS_GPU = maring.o gpu.o

DEPS = $(SRC_DIR)/engine.h $(SRC_DIR)/arith.h
DEPS_MERS = $(SRC_DIR)/mersenne.h $(SRC_DIR)/ibdwt.h $(SRC_DIR)/file.h

EXEC_CPU = $(BIN_DIR)\marin_cpu.exe
EXEC_GPU = $(BIN_DIR)\marin.exe

build: $(EXEC_CPU) $(EXEC_GPU)

clean:
	del $(OBJS_CPU) $(OBJS_GPU) $(EXEC_CPU) $(EXEC_GPU)

marinc.o: $(SRC_DIR)/marin.cpp $(DEPS) $(DEPS_MERS)
	$(CC) $(CFLAGS) $(FLAGS_CPU) -c $< -o $@

maring.o: $(SRC_DIR)/marin.cpp $(DEPS) $(DEPS_MERS) $(SRC_DIR)/ocl.h
	$(CC) $(CFLAGS) $(FLAGS_GPU) $(OCL_INC) -c $< -o $@

cpu.o: $(SRC_DIR)/cpu.cpp $(DEPS) $(SRC_DIR)/engine_cpu.h
	$(CC) $(CFLAGS) $(FLAGS_CPU) -c $< -o $@

gpu.o: $(SRC_DIR)/gpu.cpp $(DEPS) $(SRC_DIR)/engine_gpu.h $(SRC_DIR)/ocl.h
	$(CC) $(CFLAGS) $(FLAGS_GPU) $(OCL_INC) -c $< -o $@

$(EXEC_CPU): $(OBJS_CPU)
	$(CC) $(FLAGS_CPU) -static $^ -lgmp -o $@

$(EXEC_GPU): $(OBJS_GPU)
	$(CC) $(FLAGS_GPU) -static $^ -lgmp $(OCL_LIB) -o $@
